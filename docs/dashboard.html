<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blackonstar AI — Signup & Login</title>
  <style>
    /* ... existing styles ... */
    
    /* Referral Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: #121212;
      padding: 30px;
      border-radius: 18px;
      box-shadow: 0 8px 30px rgba(0, 255, 213, 0.3);
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    
    .close-modal {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close-modal:hover {
      color: #00ffd5;
    }
  </style>
</head>
<body>
  <!-- ... existing HTML ... -->
  
  <!-- Referral Modal -->
  <div id="referral-modal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2>Enter Referral Code</h2>
      <p>Get 10 BK tokens for using a referral code!</p>
      <input type="text" id="modal-referral-code" placeholder="Enter referral code" style="width: 100%; padding: 14px; margin: 15px 0; border-radius: 12px; border: 1.5px solid #333; background: #1f1f1f; color: #eee;" />
      <button id="apply-referral-btn" style="background: #00ffd5; color: #000; border: none; padding: 14px 0; border-radius: 30px; font-size: 16px; font-weight: 700; cursor: pointer; width: 100%;">Apply Code</button>
      <p id="referral-message" style="margin-top: 15px; color: #ff6b6b; min-height: 24px;"></p>
      <button id="skip-referral-btn" style="background: transparent; color: #888; border: none; margin-top: 10px; cursor: pointer;">Skip for now</button>
    </div>
  </div>

  <script type="module">
    // ... existing imports and setup ...
    
    // Modal elements
    const modal = document.getElementById('referral-modal');
    const closeModal = document.querySelector('.close-modal');
    const modalReferralCode = document.getElementById('modal-referral-code');
    const applyReferralBtn = document.getElementById('apply-referral-btn');
    const referralMessage = document.getElementById('referral-message');
    const skipReferralBtn = document.getElementById('skip-referral-btn');
    
    // Store referral data
    let referralInfo = {
      code: null,
      referrerId: null,
      isValid: false
    };
    
    // Open referral modal after successful signup
    function openReferralModal() {
      modal.style.display = 'flex';
      modalReferralCode.value = '';
      referralMessage.textContent = '';
    }
    
    // Close modal
    closeModal.onclick = function() {
      modal.style.display = 'none';
    }
    
    skipReferralBtn.onclick = function() {
      modal.style.display = 'none';
      // Redirect to dashboard or next step
      window.location.href = '/dashboard';
    }
    
    // Apply referral code
    applyReferralBtn.addEventListener('click', async () => {
      const code = modalReferralCode.value.trim().toUpperCase();
      
      if (!code) {
        referralMessage.textContent = 'Please enter a referral code';
        return;
      }
      
      applyReferralBtn.disabled = true;
      referralMessage.textContent = 'Verifying code...';
      
      try {
        // Query WITHOUT .single() to avoid PGRST116 errors
        const { data, error } = await supabase
          .from('users')
          .select('id, bk_tokens, referral_count')
          .eq('referral_code', code)
          .limit(1);
        
        if (error) {
          referralMessage.textContent = 'Error checking code: ' + error.message;
          applyReferralBtn.disabled = false;
          return;
        }
        
        if (!data || data.length === 0) {
          referralMessage.textContent = 'Invalid referral code';
          applyReferralBtn.disabled = false;
          return;
        }
        
        // Valid referral code
        const referrer = data[0];
        referralInfo = {
          code: code,
          referrerId: referrer.id,
          isValid: true
        };
        
        // Reward current user (10 tokens)
        const { error: rewardError } = await supabase
          .from('users')
          .update({ 
            bk_tokens: 10,
            invitation_code: code
          })
          .eq('id', currentUser.id); // You'll need to track currentUser after signup
        
        if (rewardError) {
          referralMessage.textContent = 'Failed to reward you: ' + rewardError.message;
          applyReferralBtn.disabled = false;
          return;
        }
        
        // Reward referrer (50 tokens + increment referral count)
        const newTokens = (referrer.bk_tokens || 0) + 50;
        const newReferralCount = (referrer.referral_count || 0) + 1;
        
        const { error: referrerError } = await supabase
          .from('users')
          .update({
            bk_tokens: newTokens,
            referral_count: newReferralCount
          })
          .eq('id', referrer.id);
        
        if (referrerError) {
          console.warn('Failed to reward referrer:', referrerError.message);
        }
        
        referralMessage.textContent = '✅ Code applied! You got 10 BK tokens!';
        referralMessage.style.color = '#69f0ae';
        
        // Close modal after delay
        setTimeout(() => {
          modal.style.display = 'none';
          window.location.href = '/dashboard';
        }, 2000);
        
      } catch (err) {
        referralMessage.textContent = 'Error: ' + err.message;
        applyReferralBtn.disabled = false;
      }
    });
    
    // Modified signup to not handle referral codes during signup
    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      message.textContent = '';
      signupBtn.disabled = true;

      const name = signupForm['name'].value.trim();
      const email = signupForm['email-signup'].value.trim();
      const password = signupForm['password-signup'].value;
      const confirmPassword = signupForm['confirm-password'].value;

      // Validation
      if (password !== confirmPassword) {
        message.textContent = '⚠️ Passwords do not match.';
        signupBtn.disabled = false;
        return;
      }
      if (password.length < 6) {
        message.textContent = '⚠️ Password must be at least 6 characters.';
        signupBtn.disabled = false;
        return;
      }

      message.textContent = 'Signing up...';

      try {
        // Sign up with Supabase Auth
        const { data, error } = await supabase.auth.signUp({
          email,
          password,
          options: {
            data: { display_name: name }
          }
        });

        if (error) {
          message.textContent = 'Error: ' + error.message;
          signupBtn.disabled = false;
          return;
        }

        if (!data?.user?.id) {
          message.textContent = 'Error: User ID not returned.';
          signupBtn.disabled = false;
          return;
        }

        const userId = data.user.id;
        const referralCode = generateReferralCode();

        // Insert new user record with 0 tokens initially
        const { error: upsertError } = await supabase
          .from('users')
          .insert({
            id: userId,
            email,
            display_name: name,
            referral_code: referralCode,
            bk_tokens: 0,
            referral_count: 0,
            updated_at: new Date().toISOString()
          });

        if (upsertError) {
          message.textContent = 'Signup succeeded but failed to save user data: ' + upsertError.message;
          signupBtn.disabled = false;
          return;
        }

        message.textContent = '✅ Sign up successful! Redirecting...';
        message.classList.add('success');

        // Clear signup form
        signupForm.reset();

        // Store current user ID for referral processing
        window.currentUser = { id: userId };

        // Open referral modal after short delay
        setTimeout(() => {
          openReferralModal();
        }, 1500);
        
      } catch (err) {
        message.textContent = 'Error: ' + err.message;
        signupBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
