<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackonstar AI - Dashboard</title>
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="logo">
                <h1>Blackonstar AI</h1>
            </div>
            <div class="user-info">
                <span class="username">Welcome, <strong id="user-display-name">Loading...</strong></span>
                <div class="avatar" id="user-avatar">U</div>
            </div>
        </header>

        <!-- Main Dashboard -->
        <main class="dashboard-main">
            <!-- Balance Section -->
            <section class="balance-section">
                <div class="spot-value">
                    <h3>Spot Value (est.)</h3>
                    <div class="value-display">
                        <span class="btc-value" id="total-bk-tokens">0 BK</span>
                        <span class="usd-value">≈ $<span id="usd-equivalent">0.00</span> USD</span>
                    </div>
                </div>
                
                <div class="pnl-section">
                    <h3>Today's PnL</h3>
                    <div class="pnl-value">
                        <span class="amount">$<span id="today-pnl-usd">0.00</span> USD</span>
                        <span class="percentage" id="today-pnl-percent">0.00%</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn add-funds" id="exchange-btn">
                        <i class="fas fa-exchange-alt"></i> Exchange
                    </button>
                    <button class="btn withdraw" id="withdraw-btn">
                        <i class="fas fa-minus-circle"></i> Withdraw
                    </button>
                </div>
            </section>

            <!-- Wallet Cards -->
            <section class="wallet-section">
                <div class="wallet-card spot-wallet">
                    <div class="wallet-header">
                        <h3>Spot Wallet</h3>
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="wallet-balance">
                        <span class="amount" id="spot-balance">0.00 BK</span>
                        <span class="equivalent">≈ $<span id="spot-usd">0.00</span> USD</span>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn transfer-btn" data-from="spot" data-to="futures">Transfer</button>
                    </div>
                </div>
                
                <div class="wallet-card futures-wallet">
                    <div class="wallet-header">
                        <h3>USDT-M Futures</h3>
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="wallet-balance">
                        <span class="amount" id="futures-balance">0.00 BK</span>
                        <span class="equivalent">≈ $<span id="futures-usd">0.00</span> USD</span>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn transfer-btn" data-from="futures" data-to="spot">Transfer</button>
                    </div>
                </div>
            </section>

            <!-- Transfer Section -->
            <section class="transfer-section">
                <h2 class="section-title">Transfer BK</h2>
                <div class="transfer-container">
                    <div class="transfer-form">
                        <div class="transfer-row">
                            <div class="transfer-column">
                                <label>From</label>
                                <div class="wallet-selector from-wallet">
                                    <select id="transfer-from">
                                        <option value="futures">USDT-M Futures</option>
                                        <option value="spot">Spot</option>
                                    </select>
                                    <span class="balance-info">Available: <span id="from-available">0.00</span> BK</span>
                                </div>
                            </div>
                            
                            <div class="transfer-column">
                                <label>To</label>
                                <div class="wallet-selector to-wallet">
                                    <select id="transfer-to">
                                        <option value="spot">Spot</option>
                                        <option value="futures">USDT-M Futures</option>
                                    </select>
                                    <span class="balance-info">Available: <span id="to-available">0.00</span> BK</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="transfer-row coin-row">
                            <label>Coin</label>
                            <div class="coin-display">
                                <span class="coin-icon">BK</span>
                                <span class="coin-name">BK Token</span>
                            </div>
                        </div>
                        
                        <div class="transfer-row amount-row">
                            <label>Transfer Amount</label>
                            <div class="amount-input">
                                <input type="number" id="transfer-amount" placeholder="Enter amount" step="0.01" min="0">
                                <button class="max-btn" id="max-transfer">Max</button>
                            </div>
                            <span class="available-balance">Available: <span id="max-available-amount">0.00</span> BK</span>
                        </div>
                        
                        <button class="btn transfer-submit" id="submit-transfer">Transfer</button>
                    </div>
                </div>
            </section>

            <!-- Activities Section -->
            <section class="activities-section">
                <div class="activity-card checkin-card">
                    <div class="activity-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="activity-content">
                        <h3>Daily Check-in</h3>
                        <p>Claim your daily rewards</p>
                        <button class="btn claim-btn" id="checkin-btn">Claim Now</button>
                        <div class="checkin-status" id="checkin-status">Last checked in: Never</div>
                    </div>
                </div>
                
                <div class="activity-card spin-card">
                    <div class="activity-icon">
                        <i class="fas fa-spinner"></i>
                    </div>
                    <div class="activity-content">
                        <h3>Spin to Win</h3>
                        <p>Try your luck to win prizes</p>
                        <button class="btn spin-btn" id="spin-btn">Spin Now (1 BK)</button>
                    </div>
                </div>
                
                <div class="activity-card exchange-card">
                    <div class="activity-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                    <div class="activity-content">
                        <h3>Exchange</h3>
                        <p>Convert your tokens (Min 1000 BK)</p>
                        <button class="btn exchange-btn" id="quick-exchange-btn">Exchange</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Withdraw Modal -->
        <div class="modal" id="withdraw-modal">
            <div class="modal-content">
                <span class="close-modal" id="close-withdraw-modal">&times;</span>
                <h2 class="modal-title">Withdraw Funds</h2>
                <form id="withdraw-form">
                    <div class="form-group">
                        <label for="wallet-address">BSC Wallet Address</label>
                        <input type="text" id="wallet-address" class="form-control" placeholder="Enter your BSC wallet address">
                    </div>
                    <div class="form-group">
                        <label for="full-name">Full Name</label>
                        <input type="text" id="full-name" class="form-control" placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label for="withdraw-amount">Amount (BK Tokens)</label>
                        <input type="number" id="withdraw-amount" class="form-control" placeholder="Enter amount" step="1" min="1000">
                        <div class="form-hint">Minimum withdrawal: 1000 BK ($1.00 USD)</div>
                    </div>
                    <button type="submit" class="submit-btn">Process Withdrawal</button>
                </form>
            </div>
        </div>

        <!-- Exchange Modal -->
        <div class="modal" id="exchange-modal">
            <div class="modal-content">
                <span class="close-modal" id="close-exchange-modal">&times;</span>
                <h2 class="modal-title">Exchange BK to USDT</h2>
                <div class="exchange-info">
                    <div class="exchange-rate">
                        <span>Exchange Rate:</span>
                        <span class="rate-value">1000 BK = 1 USDT</span>
                    </div>
                    <div class="available-balance">
                        <span>Available Balance:</span>
                        <span id="exchange-available-balance">0 BK</span>
                    </div>
                </div>
                <form id="exchange-form">
                    <div class="form-group">
                        <label for="exchange-amount">Amount to Exchange (BK)</label>
                        <input type="number" id="exchange-amount" class="form-control" placeholder="Enter amount" step="1" min="1000">
                        <div class="form-hint">You will receive <span id="exchange-estimate">0.00</span> USDT</div>
                    </div>
                    <button type="submit" class="submit-btn">Exchange</button>
                </form>
            </div>
        </div>

        <!-- Notification -->
        <div class="notification" id="notification">Operation completed successfully!</div>

        <!-- Footer -->
        <footer class="dashboard-footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="home.html">Home</a></li>
                        <li><a href="chat.html">Chat AI</a></li>
                        <li><a href="referral.html">Referral</a></li>
                        <li><a href="dashboard.html" class="active">Dashboard</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Support</h4>
                    <ul>
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">FAQ</a></li>
                        <li><a href="#">Contact Us</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Legal</h4>
                    <ul>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Risk Disclosure</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Follow Us</h4>
                    <div class="social-icons">
                        <a href="#"><i class="fab fa-telegram"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-discord"></i></a>
                    </div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2025 Blackonstar AI. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

        // Initialize Supabase client
        const SUPABASE_URL = 'YOUR_SUPABASE_URL'
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // DOM Elements
        const userDisplayName = document.getElementById('user-display-name')
        const userAvatar = document.getElementById('user-avatar')
        const totalBkTokens = document.getElementById('total-bk-tokens')
        const usdEquivalent = document.getElementById('usd-equivalent')
        const spotBalance = document.getElementById('spot-balance')
        const spotUsd = document.getElementById('spot-usd')
        const futuresBalance = document.getElementById('futures-balance')
        const futuresUsd = document.getElementById('futures-usd')
        const fromAvailable = document.getElementById('from-available')
        const toAvailable = document.getElementById('to-available')
        const maxAvailableAmount = document.getElementById('max-available-amount')
        const transferAmount = document.getElementById('transfer-amount')
        const transferFrom = document.getElementById('transfer-from')
        const transferTo = document.getElementById('transfer-to')
        const submitTransfer = document.getElementById('submit-transfer')
        const maxTransfer = document.getElementById('max-transfer')
        const checkinBtn = document.getElementById('checkin-btn')
        const checkinStatus = document.getElementById('checkin-status')
        const spinBtn = document.getElementById('spin-btn')
        const exchangeBtn = document.getElementById('exchange-btn')
        const quickExchangeBtn = document.getElementById('quick-exchange-btn')
        const withdrawBtn = document.getElementById('withdraw-btn')
        const withdrawModal = document.getElementById('withdraw-modal')
        const exchangeModal = document.getElementById('exchange-modal')
        const closeWithdrawModal = document.getElementById('close-withdraw-modal')
        const closeExchangeModal = document.getElementById('close-exchange-modal')
        const withdrawForm = document.getElementById('withdraw-form')
        const exchangeForm = document.getElementById('exchange-form')
        const walletAddress = document.getElementById('wallet-address')
        const fullName = document.getElementById('full-name')
        const withdrawAmount = document.getElementById('withdraw-amount')
        const exchangeAmount = document.getElementById('exchange-amount')
        const exchangeEstimate = document.getElementById('exchange-estimate')
        const exchangeAvailableBalance = document.getElementById('exchange-available-balance')
        const notification = document.getElementById('notification')

        // State variables
        let currentUser = null
        let wallets = {}
        let lastCheckin = null
        let savedAddress = null
        let exchangeRate = 0.001 // 1000 BK = 1 USDT

        // Initialize dashboard
        async function initDashboard() {
            try {
                // Check authentication
                const { data: { user }, error: authError } = await supabase.auth.getUser()
                
                if (authError || !user) {
                    window.location.href = 'login.html'
                    return
                }
                
                currentUser = user
                
                // Set user info
                const displayName = user.email?.split('@')[0] || 'User'
                userDisplayName.textContent = displayName
                userAvatar.textContent = displayName.charAt(0).toUpperCase()
                
                // Load data
                await Promise.all([
                    loadWallets(),
                    loadExchangeRate(),
                    loadCheckinStatus(),
                    loadSavedAddress()
                ])
                
                // Update UI
                updateBalancesUI()
                
            } catch (err) {
                console.error('Initialization error:', err)
                showNotification('Failed to load dashboard', true)
            }
        }

        // Load user wallets
        async function loadWallets() {
            try {
                const { data, error } = await supabase
                    .from('wallets')
                    .select('*')
                    .eq('user_id', currentUser.id)
                
                if (error) throw error
                
                // Reset wallets object
                wallets = {}
                
                // Store wallets by type
                data.forEach(wallet => {
                    wallets[wallet.wallet_type] = wallet
                })
                
                // Create default wallets if they don't exist
                if (!wallets.spot) {
                    await createDefaultWallet('spot')
                }
                
                if (!wallets.futures) {
                    await createDefaultWallet('futures')
                }
                
                // Refresh wallets after creation
                if (!wallets.spot || !wallets.futures) {
                    const { data: refreshedData, error: refreshError } = await supabase
                        .from('wallets')
                        .select('*')
                        .eq('user_id', currentUser.id)
                    
                    if (!refreshError) {
                        wallets = {}
                        refreshedData.forEach(wallet => {
                            wallets[wallet.wallet_type] = wallet
                        })
                    }
                }
                
                updateTransferUI()
                
            } catch (err) {
                console.error('Error loading wallets:', err)
                showNotification('Failed to load wallets', true)
            }
        }

        // Create default wallet
        async function createDefaultWallet(walletType) {
            try {
                // Get initial balance from user's bk_tokens if spot wallet
                let initialBalance = 0
                if (walletType === 'spot') {
                    const { data: userData, error: userError } = await supabase
                        .from('users')
                        .select('bk_tokens')
                        .eq('id', currentUser.id)
                        .single()
                    
                    if (!userError && userData?.bk_tokens) {
                        initialBalance = userData.bk_tokens
                        
                        // Update user's bk_tokens to 0 after migration
                        await supabase
                            .from('users')
                            .update({ bk_tokens: 0 })
                            .eq('id', currentUser.id)
                    }
                }
                
                const { error } = await supabase
                    .from('wallets')
                    .insert({
                        user_id: currentUser.id,
                        wallet_type: walletType,
                        balance: initialBalance,
                        token_symbol: 'BK'
                    })
                
                if (error) throw error
                return true
                
            } catch (err) {
                console.error(`Error creating ${walletType} wallet:`, err)
                return false
            }
        }

        // Load exchange rate
        async function loadExchangeRate() {
            try {
                const { data, error } = await supabase
                    .from('exchange_rates')
                    .select('rate')
                    .eq('from_token', 'BK')
                    .eq('to_token', 'USDT')
                    .single()
                
                if (!error && data) {
                    exchangeRate = data.rate
                }
                
            } catch (err) {
                console.error('Error loading exchange rate:', err)
            }
        }

        // Load check-in status
        async function loadCheckinStatus() {
            try {
                const today = new Date().toISOString().split('T')[0]
                
                const { data, error } = await supabase
                    .from('daily_checkins')
                    .select('created_at')
                    .eq('user_id', currentUser.id)
                    .eq('checkin_date', today)
                    .single()
                
                if (!error && data) {
                    lastCheckin = new Date(data.created_at)
                    checkinBtn.disabled = true
                    checkinBtn.textContent = 'Already Checked In'
                    checkinStatus.textContent = `Last checked in: Today`
                } else {
                    checkinBtn.disabled = false
                    checkinBtn.textContent = 'Claim Now'
                    checkinStatus.textContent = 'Last checked in: Never'
                }
                
            } catch (err) {
                console.log('No check-in today')
                checkinBtn.disabled = false
                checkinBtn.textContent = 'Claim Now'
                checkinStatus.textContent = 'Last checked in: Never'
            }
        }

        // Load saved withdrawal address
        async function loadSavedAddress() {
            try {
                const { data, error } = await supabase
                    .from('withdrawal_addresses')
                    .select('wallet_address, full_name')
                    .eq('user_id', currentUser.id)
                    .eq('is_default', true)
                    .single()
                
                if (!error && data) {
                    savedAddress = data
                    walletAddress.value = data.wallet_address || ''
                    fullName.value = data.full_name || ''
                }
                
            } catch (err) {
                console.log('No saved withdrawal address')
            }
        }

        // Update balances UI
        function updateBalancesUI() {
            const spotWallet = wallets.spot || { balance: 0 }
            const futuresWallet = wallets.futures || { balance: 0 }
            
            const totalBalance = parseFloat(spotWallet.balance) + parseFloat(futuresWallet.balance)
            
            // Update main balances
            totalBkTokens.textContent = `${totalBalance.toFixed(2)} BK`
            usdEquivalent.textContent = (totalBalance * exchangeRate).toFixed(2)
            
            // Update wallet cards
            spotBalance.textContent = `${parseFloat(spotWallet.balance).toFixed(2)} BK`
            spotUsd.textContent = (parseFloat(spotWallet.balance) * exchangeRate).toFixed(2)
            
            futuresBalance.textContent = `${parseFloat(futuresWallet.balance).toFixed(2)} BK`
            futuresUsd.textContent = (parseFloat(futuresWallet.balance) * exchangeRate).toFixed(2)
            
            // Update exchange modal
            exchangeAvailableBalance.textContent = `${totalBalance.toFixed(2)} BK`
            updateExchangeEstimate()
        }

        // Update transfer UI based on selections
        function updateTransferUI() {
            const fromWallet = transferFrom.value
            const toWallet = transferTo.value
            
            // Prevent transferring to same wallet
            if (fromWallet === toWallet) {
                const options = Array.from(transferTo.options)
                options.forEach(option => {
                    option.disabled = (option.value === fromWallet)
                })
                
                // Select a different wallet
                if (transferTo.value === fromWallet) {
                    const nextOption = options.find(opt => opt.value !== fromWallet)
                    if (nextOption) {
                        transferTo.value = nextOption.value
                    }
                }
            }
            
            // Update available balances
            const fromWalletData = wallets[fromWallet] || { balance: 0 }
            const toWalletData = wallets[toWallet] || { balance: 0 }
            
            fromAvailable.textContent = parseFloat(fromWalletData.balance).toFixed(2)
            toAvailable.textContent = parseFloat(toWalletData.balance).toFixed(2)
            maxAvailableAmount.textContent = parseFloat(fromWalletData.balance).toFixed(2)
        }

        // Update exchange estimate
        function updateExchangeEstimate() {
            const amount = parseFloat(exchangeAmount.value) || 0
            const estimate = amount * exchangeRate
            exchangeEstimate.textContent = estimate.toFixed(4)
        }

        // Handle transfer
        async function handleTransfer() {
            const fromWalletType = transferFrom.value
            const toWalletType = transferTo.value
            const amount = parseFloat(transferAmount.value)
            
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount', true)
                return
            }
            
            const fromWallet = wallets[fromWalletType]
            const toWallet = wallets[toWalletType]
            
            if (!fromWallet || !toWallet) {
                showNotification('Wallets not found', true)
                return
            }
            
            if (amount > parseFloat(fromWallet.balance)) {
                showNotification('Insufficient balance', true)
                return
            }
            
            try {
                // Start transaction
                const { error } = await supabase.rpc('transfer_tokens', {
                    p_user_id: currentUser.id,
                    p_from_wallet_id: fromWallet.id,
                    p_to_wallet_id: toWallet.id,
                    p_amount: amount
                })
                
                if (error) throw error
                
                // Reload wallets
                await loadWallets()
                
                // Reset form
                transferAmount.value = ''
                
                showNotification(`Successfully transferred ${amount} BK from ${fromWalletType} to ${toWalletType}`)
                
            } catch (err) {
                console.error('Transfer error:', err)
                showNotification('Transfer failed: ' + (err.message || 'Unknown error'), true)
            }
        }

        // Handle check-in
        async function handleCheckin() {
            try {
                const today = new Date().toISOString().split('T')[0]
                
                // Award tokens (50 BK)
                const { error: awardError } = await supabase.rpc('award_checkin_tokens', {
                    p_user_id: currentUser.id,
                    p_amount: 50
                })
                
                if (awardError) throw awardError
                
                // Record check-in
                const { error: checkinError } = await supabase
                    .from('daily_checkins')
                    .insert({
                        user_id: currentUser.id,
                        checkin_date: today,
                        tokens_earned: 50
                    })
                
                if (checkinError) throw checkinError
                
                // Reload wallets
                await loadWallets()
                await loadCheckinStatus()
                
                showNotification('50 BK tokens awarded for daily check-in!')
                
            } catch (err) {
                console.error('Check-in error:', err)
                showNotification('Check-in failed: ' + (err.message || 'Unknown error'), true)
            }
        }

        // Handle spin
        async function handleSpin() {
            try {
                // Deduct 1 token for spin
                const { error: spinError } = await supabase.rpc('deduct_spin_cost', {
                    p_user_id: currentUser.id
                })
                
                if (spinError) throw spinError
                
                // Determine prize (for demo, mostly 0 BK)
                const prizes = [0, 0, 0, 0, 0, 1, 100, 1000, 100000]
                const prize = Math.random() > 0.95 ? prizes[Math.floor(Math.random() * prizes.length)] : 0
                
                // Award prize
                if (prize > 0) {
                    const { error: awardError } = await supabase.rpc('award_spin_prize', {
                        p_user_id: currentUser.id,
                        p_amount: prize
                    })
                    
                    if (awardError) throw awardError
                }
                
                // Record spin
                const { error: recordError } = await supabase
                    .from('spin_records')
                    .insert({
                        user_id: currentUser.id,
                        tokens_spent: 1,
                        prize_won: `${prize}bk`,
                        tokens_won: prize
                    })
                
                // Reload wallets
                await loadWallets()
                
                if (prize > 0) {
                    showNotification(`Congratulations! You won ${prize} BK tokens!`)
                } else {
                    showNotification('Better luck next time! Try again.')
                }
                
            } catch (err) {
                console.error('Spin error:', err)
                if (err.message?.includes('insufficient')) {
                    showNotification('Not enough tokens to spin. Minimum: 1 BK', true)
                } else {
                    showNotification('Spin failed: ' + (err.message || 'Unknown error'), true)
                }
            }
        }

        // Handle withdrawal form submission
        async function handleWithdraw(e) {
            e.preventDefault()
            
            const address = walletAddress.value.trim()
            const name = fullName.value.trim()
            const amount = parseFloat(withdrawAmount.value)
            
            if (!address || !name) {
                showNotification('Please fill all required fields', true)
                return
            }
            
            if (!amount || amount < 1000) {
                showNotification('Minimum withdrawal is 1000 BK tokens', true)
                return
            }
            
            try {
                // Save withdrawal address
                const { error: addressError } = await supabase
                    .from('withdrawal_addresses')
                    .upsert({
                        user_id: currentUser.id,
                        wallet_address: address,
                        full_name: name,
                        is_default: true
                    }, { onConflict: 'user_id' })
                
                if (addressError) throw addressError
                
                // Process withdrawal
                const { error: withdrawError } = await supabase.rpc('process_withdrawal', {
                    p_user_id: currentUser.id,
                    p_amount: amount,
                    p_address: address
                })
                
                if (withdrawError) throw withdrawError
                
                // Reload wallets
                await loadWallets()
                
                // Close modal and reset form
                withdrawModal.style.display = 'none'
                withdrawForm.reset()
                
                showNotification(`Withdrawal of ${amount} BK tokens initiated!`)
                
            } catch (err) {
                console.error('Withdrawal error:', err)
                if (err.message?.includes('insufficient')) {
                    showNotification('Insufficient balance for withdrawal', true)
                } else {
                    showNotification('Withdrawal failed: ' + (err.message || 'Unknown error'), true)
                }
            }
        }

        // Handle exchange form submission
        async function handleExchange(e) {
            e.preventDefault()
            
            const amount = parseFloat(exchangeAmount.value)
            
            if (!amount || amount < 1000) {
                showNotification('Minimum exchange is 1000 BK tokens', true)
                return
            }
            
            try {
                // Process exchange
                const { error: exchangeError } = await supabase.rpc('process_exchange', {
                    p_user_id: currentUser.id,
                    p_bk_amount: amount
                })
                
                if (exchangeError) throw exchangeError
                
                // Reload wallets
                await loadWallets()
                
                // Close modal and reset form
                exchangeModal.style.display = 'none'
                exchangeForm.reset()
                
                const usdtAmount = amount * exchangeRate
                showNotification(`Exchanged ${amount} BK for ${usdtAmount.toFixed(4)} USDT!`)
                
            } catch (err) {
                console.error('Exchange error:', err)
                if (err.message?.includes('insufficient')) {
                    showNotification('Insufficient balance for exchange', true)
                } else {
                    showNotification('Exchange failed: ' + (err.message || 'Unknown error'), true)
                }
            }
        }

        // Show notification
        function showNotification(message, isError = false) {
            notification.textContent = message
            notification.className = 'notification'
            
            if (isError) {
                notification.classList.add('error')
            } else {
                notification.classList.remove('error')
            }
            
            notification.classList.add('show')
            
            setTimeout(() => {
                notification.classList.remove('show')
            }, 3000)
        }

        // Event Listeners
        transferFrom.addEventListener('change', updateTransferUI)
        transferTo.addEventListener('change', updateTransferUI)
        transferAmount.addEventListener('input', () => {
            const maxAmount = parseFloat(fromAvailable.textContent) || 0
            const enteredAmount = parseFloat(transferAmount.value) || 0
            
            if (enteredAmount > maxAmount) {
                transferAmount.value = maxAmount.toFixed(2)
            }
        })
        
        maxTransfer.addEventListener('click', () => {
            transferAmount.value = fromAvailable.textContent
        })
        
        submitTransfer.addEventListener('click', handleTransfer)
        checkinBtn.addEventListener('click', handleCheckin)
        spinBtn.addEventListener('click', handleSpin)
        
        exchangeBtn.addEventListener('click', () => {
            exchangeModal.style.display = 'flex'
        })
        
        quickExchangeBtn.addEventListener('click', () => {
            exchangeModal.style.display = 'flex'
        })
        
        withdrawBtn.addEventListener('click', () => {
            withdrawModal.style.display = 'flex'
        })
        
        closeWithdrawModal.addEventListener('click', () => {
            withdrawModal.style.display = 'none'
        })
        
        closeExchangeModal.addEventListener('click', () => {
            exchangeModal.style.display = 'none'
        })
        
        withdrawForm.addEventListener('submit', handleWithdraw)
        exchangeForm.addEventListener('submit', handleExchange)
        
        exchangeAmount.addEventListener('input', updateExchangeEstimate)
        
        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === withdrawModal) {
                withdrawModal.style.display = 'none'
            }
            if (e.target === exchangeModal) {
                exchangeModal.style.display = 'none'
            }
        })

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initDashboard)
    </script>
</body>
</html>
