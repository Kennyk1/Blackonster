<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BK Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="loader" class="loader">Loading...</div>

  <!-- Wallet Creation Modal -->
  <div id="createWalletModal" class="modal hidden">
    <div class="modal-content">
      <h2>Welcome ðŸ‘‹</h2>
      <p id="welcomeName"></p>
      <p>You donâ€™t have a wallet yet. Create one now to start earning BK Tokens!</p>
      <input type="text" id="fullName" placeholder="Full Name" />
      <input type="text" id="walletAddress" placeholder="Withdrawal Address" />
      <button id="createWalletBtn">Create Wallet</button>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard" class="hidden">
    <header>
      <h1>Welcome, <span id="displayName"></span></h1>
      <div class="actions">
        <button id="historyBtn">History</button>
        <button id="manageAddressBtn">Manage Address</button>
        <button id="logoutBtn">Logout</button>
      </div>
    </header>

    <section class="balances">
      <div class="wallet-card">
        <h3>Spot Wallet</h3>
        <p><span id="spotBalance">0</span> BK</p>
      </div>
      <div class="wallet-card">
        <h3>Futures Wallet</h3>
        <p><span id="futuresBalance">0</span> BK</p>
      </div>
    </section>

    <section class="controls">
      <button id="exchangeBtn">Exchange</button>
      <button id="transferBtn">Transfer</button>
      <button id="withdrawBtn">Withdraw</button>
    </section>
  </div>

  <!-- Manage Address Modal -->
  <div id="manageAddressModal" class="modal hidden">
    <div class="modal-content">
      <h2>Manage Withdrawal Address</h2>
      <input type="text" id="newAddress" placeholder="Enter new withdrawal address" />
      <input type="text" id="newFullName" placeholder="Full name" />
      <button id="saveAddressBtn">Save</button>
      <button onclick="closeModal('manageAddressModal')">Close</button>
    </div>
  </div>

  <!-- Generic Modal -->
  <div id="alertModal" class="modal hidden">
    <div class="modal-content">
      <p id="alertMessage"></p>
      <button onclick="closeModal('alertModal')">OK</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Supabase setup (replace with your real keys)
    const SUPABASE_URL = "https://nnixqnoxlhdncoppukvw.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uaXhxbm94bGhkbmNvcHB1a3Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MzMyNjIsImV4cCI6MjA3NjQwOTI2Mn0.F2vIAkiX29Bqe7jpJhYPRzjUNJ3n0Fs3Emca-8I9JuE"
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const dashboard = document.getElementById("dashboard");
    const loader = document.getElementById("loader");
    const createWalletModal = document.getElementById("createWalletModal");
    const welcomeName = document.getElementById("welcomeName");

    const displayNameEl = document.getElementById("displayName");
    const spotBalanceEl = document.getElementById("spotBalance");
    const futuresBalanceEl = document.getElementById("futuresBalance");

    async function initDashboard() {
      loader.style.display = "flex";

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      displayNameEl.textContent = user.email;
      welcomeName.textContent = `Hey ${user.email}!`;

      // Check wallet existence
      const { data: wallets } = await supabase
        .from("wallets")
        .select("*")
        .eq("user_id", user.id);

      if (!wallets || wallets.length === 0) {
        // No wallet yet
        loader.style.display = "none";
        createWalletModal.classList.remove("hidden");
        return;
      }

      // Wallets exist
      loader.style.display = "none";
      dashboard.classList.remove("hidden");

      const spotWallet = wallets.find(w => w.wallet_type === "spot");
      const futuresWallet = wallets.find(w => w.wallet_type === "futures");

      spotBalanceEl.textContent = spotWallet ? spotWallet.balance : "0";
      futuresBalanceEl.textContent = futuresWallet ? futuresWallet.balance : "0";
    }

    async function createWallet() {
      const { data: { user } } = await supabase.auth.getUser();
      const fullName = document.getElementById("fullName").value.trim();
      const walletAddress = document.getElementById("walletAddress").value.trim();

      if (!fullName || !walletAddress) {
        return showAlert("Please enter your full name and withdrawal address.");
      }

      const { data, error } = await supabase.rpc("create_user_wallet_with_bonus", {
        p_user_id: user.id,
        p_full_name: fullName,
        p_wallet_address: walletAddress
      });

      if (error) {
        console.error(error);
        showAlert("Error: " + error.message);
        return;
      }

      showAlert("âœ… Wallet created successfully! Youâ€™ve received 100 BK bonus.");
      createWalletModal.classList.add("hidden");
      dashboard.classList.remove("hidden");
      initDashboard();
    }

    function showAlert(message) {
      document.getElementById("alertMessage").textContent = message;
      document.getElementById("alertModal").classList.remove("hidden");
    }

    function closeModal(id) {
      document.getElementById(id).classList.add("hidden");
    }

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });

    // History
    document.getElementById("historyBtn").addEventListener("click", () => {
      window.location.href = "history.html";
    });

    // Manage Address
    document.getElementById("manageAddressBtn").addEventListener("click", () => {
      document.getElementById("manageAddressModal").classList.remove("hidden");
    });

    document.getElementById("saveAddressBtn").addEventListener("click", async () => {
      const { data: { user } } = await supabase.auth.getUser();
      const newAddress = document.getElementById("newAddress").value.trim();
      const newFullName = document.getElementById("newFullName").value.trim();
      if (!newAddress || !newFullName) return showAlert("Please fill all fields.");

      const { error } = await supabase
        .from("withdrawal_addresses")
        .update({
          wallet_address: newAddress,
          full_name: newFullName,
          updated_at: new Date().toISOString()
        })
        .eq("user_id", user.id);

      if (error) showAlert("Error updating address: " + error.message);
      else showAlert("âœ… Address updated successfully.");
      closeModal("manageAddressModal");
    });

    document.getElementById("createWalletBtn").addEventListener("click", createWallet);

    // Initialize dashboard
    initDashboard();
  </script>
</body>
</html>
