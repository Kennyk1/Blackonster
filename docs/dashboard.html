<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blackonstar AI ‚Äî Referral Dashboard</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: #0a0a0a;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      user-select: none;
    }

    .container {
      background: #121212;
      padding: 40px 35px;
      border-radius: 18px;
      box-shadow: 0 8px 30px rgba(0, 255, 213, 0.3);
      width: 100%;
      max-width: 440px;
      user-select: text;
      text-align: center;
    }

    h2 {
      color: #00ffd5;
      font-weight: 700;
      font-size: 28px;
      margin-bottom: 25px;
      text-align: center;
      letter-spacing: 1.2px;
    }

    .referral-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }

    p {
      color: #aaa;
      margin-bottom: 25px;
      line-height: 1.6;
    }

    .highlight {
      color: #00ffd5;
      font-weight: 600;
    }

    input {
      background: #1f1f1f;
      border: 1.5px solid #333;
      border-radius: 12px;
      padding: 14px 18px;
      font-size: 16px;
      color: #eee;
      margin-bottom: 20px;
      transition: border-color 0.3s ease;
      width: 100%;
    }

    input:focus {
      outline: none;
      border-color: #00ffd5;
      box-shadow: 0 0 8px #00ffd5;
    }

    input::placeholder {
      color: #666;
    }

    button {
      background: #ff3b3b;
      color: #fff;
      border: none;
      padding: 16px 0;
      border-radius: 30px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
      box-shadow: 0 6px 15px rgba(255, 59, 59, 0.5);
      width: 100%;
      margin-bottom: 15px;
    }

    button:hover:not(:disabled) {
      background: #e03131;
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(224, 49, 49, 0.7);
    }

    button:disabled {
      background: #6b6b6b;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    #skip-btn {
      background: transparent;
      color: #888;
      box-shadow: none;
    }

    #skip-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: none;
      box-shadow: none;
    }

    #message {
      margin-top: 18px;
      font-weight: 600;
      font-size: 15px;
      min-height: 24px;
      text-align: center;
      user-select: text;
    }

    #message.success {
      color: #69f0ae;
    }

    #message.error {
      color: #ff6b6b;
    }

    .tokens-display {
      background: rgba(0, 255, 213, 0.1);
      border: 1px solid #00ffd5;
      border-radius: 12px;
      padding: 15px;
      margin: 20px 0;
    }

    .tokens-display h3 {
      color: #00ffd5;
      margin-bottom: 10px;
    }

    .tokens-count {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="container" role="main" aria-label="Referral dashboard">
    <div class="referral-icon">üéÅ</div>
    <h2>Referral Rewards</h2>
    
    <p>Enter a referral code to get <span class="highlight">10 BK tokens</span>!<br/>
    Your referrer will get <span class="highlight">50 BK tokens</span> too.</p>
    
    <div class="tokens-display">
      <h3>Your Current Tokens</h3>
      <div class="tokens-count" id="token-count">0 BK</div>
    </div>

    <input type="text" id="referral-code" placeholder="Enter referral code (e.g. ABC123DE)" autocomplete="off" />

    <button id="apply-btn">Apply Referral Code</button>
    <button id="skip-btn">Skip for Now</button>

    <p id="message" role="alert" aria-live="polite"></p>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const SUPABASE_URL = 'https://nnixqnoxlhdncoppukvw.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uaXhxbm94bGhkbmNvcHB1a3Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MzMyNjIsImV4cCI6MjA3NjQwOTI2Mn0.F2vIAkiX29Bqe7jpJhYPRzjUNJ3n0Fs3Emca-8I9JuE'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    
    // DOM elements
    const referralCodeInput = document.getElementById('referral-code')
    const applyBtn = document.getElementById('apply-btn')
    const skipBtn = document.getElementById('skip-btn')
    const message = document.getElementById('message')
    const tokenCount = document.getElementById('token-count')
    
    // Get current user
    let currentUser = null
    
    // Initialize dashboard
    async function initDashboard() {
      try {
        const { data: { user } } = await supabase.auth.getUser()
        
        if (!user) {
          window.location.href = '/login' // Redirect to login if not authenticated
          return
        }
        
        currentUser = user
        
        // Get current user tokens and CHECK FOR invitation_code
        const { data: userData, error: userError } = await supabase
          .from('users')
          .select('bk_tokens, invitation_code')
          .eq('id', user.id)
          .single()
        
        if (userError) {
          console.error('Error fetching user data:', userError)
          return
        }
        
        // Update token display
        tokenCount.textContent = (userData.bk_tokens || 0) + ' BK'
        
        // Check if user already has an invitation code applied
        if (userData.invitation_code) {
          message.textContent = 'You already used a referral code!'
          message.className = 'success'
          applyBtn.disabled = true
          referralCodeInput.disabled = true
        }
        
      } catch (err) {
        console.error('Error initializing dashboard:', err)
        message.textContent = 'Error: ' + err.message
        message.className = 'error'
      }
    }
    
    // Apply referral code
    async function applyReferralCode() {
      const code = referralCodeInput.value.trim().toUpperCase()
      
      if (!code) {
        showMessage('Please enter a referral code', 'error')
        return
      }
      
      if (code.length !== 8) {
        showMessage('Referral codes are 8 characters long', 'error')
        return
      }
      
      // Disable inputs during processing
      applyBtn.disabled = true
      referralCodeInput.disabled = true
      showMessage('Verifying code...', 'success')
      
      try {
        // Check if referral code exists by looking for referral_code in database
        const { data: referrerData, error: referrerError } = await supabase
          .from('users')
          .select('id, bk_tokens, referral_count')
          .eq('referral_code', code)
          .limit(1)
        
        if (referrerError) {
          throw new Error('Error checking referral code: ' + referrerError.message)
        }
        
        // Check if any results returned
        if (!referrerData || referrerData.length === 0) {
          showMessage('Invalid referral code. Please try again.', 'error')
          applyBtn.disabled = false
          referralCodeInput.disabled = false
          referralCodeInput.focus()
          return
        }
        
        const referrer = referrerData[0]
        
        // Check if user is trying to refer themselves
        if (referrer.id === currentUser.id) {
          showMessage('You cannot use your own referral code!', 'error')
          applyBtn.disabled = false
          referralCodeInput.disabled = false
          return
        }
        
        // Reward current user (10 tokens) and set invitation_code
        const { error: userUpdateError } = await supabase
          .from('users')
          .update({ 
            bk_tokens: 10,
            invitation_code: code  // This is what we check for!
          })
          .eq('id', currentUser.id)
        
        if (userUpdateError) {
          throw new Error('Failed to reward you: ' + userUpdateError.message)
        }
        
        // Reward referrer (50 tokens + increment referral count)
        const newTokens = (referrer.bk_tokens || 0) + 50
        const newReferralCount = (referrer.referral_count || 0) + 1
        
        const { error: referrerUpdateError } = await supabase
          .from('users')
          .update({
            bk_tokens: newTokens,
            referral_count: newReferralCount
          })
          .eq('id', referrer.id)
        
        if (referrerUpdateError) {
          console.warn('Failed to reward referrer:', referrerUpdateError.message)
          // Still show success to current user
        }
        
        // Success!
        showMessage('üéâ Success! You received 10 BK tokens!', 'success')
        tokenCount.textContent = '10 BK'
        
        // Disable further input
        applyBtn.disabled = true
        referralCodeInput.disabled = true
        
        // Redirect after delay
        setTimeout(() => {
          window.location.href = '/dashboard'
        }, 3000)
        
      } catch (err) {
        console.error('Error applying referral code:', err)
        showMessage('Error: ' + err.message, 'error')
        applyBtn.disabled = false
        referralCodeInput.disabled = false
      }
    }
    
    // Show message helper
    function showMessage(text, type) {
      message.textContent = text
      message.className = type
    }
    
    // Event listeners
    applyBtn.addEventListener('click', applyReferralCode)
    
    referralCodeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        applyReferralCode()
      }
    })
    
    skipBtn.addEventListener('click', () => {
      window.location.href = '/dashboard'
    })
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initDashboard)
  </script>
</body>
</html>
