<header>
    <button id="back-btn" style="background:#fff; color:#00a2ff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">‚Üê Back</button>
    <span style="margin-left:10px;">Transaction History</span>
</header>

<div class="container">
    <input type="text" id="search-input" placeholder="Search by user or transaction ID..." style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ccc;">
    
    <div class="filters">
        <button class="active" data-category="all">All</button>
        <button data-category="deposit">Deposit</button>
        <button data-category="withdrawal">Withdrawal</button>
        <button data-category="checkin">Check-in</button>
        <button data-category="spin">Spin</button>
        <button data-category="exchange">Exchange</button>
        <button data-category="transfer">Transfer</button>
    </div>

    <ul class="transaction-list" id="transaction-list"></ul>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const transactionList = document.getElementById('transaction-list')
    const filterButtons = document.querySelectorAll('.filters button')
    const searchInput = document.getElementById('search-input')
    const backBtn = document.getElementById('back-btn')
    let transactions = []

    backBtn.addEventListener('click', () => { window.location.href = 'dashboard.html' })

    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            filterButtons.forEach(b => b.classList.remove('active'))
            btn.classList.add('active')
            renderTransactions(btn.dataset.category, searchInput.value)
        })
    })

    searchInput.addEventListener('input', () => {
        const activeBtn = document.querySelector('.filters button.active')
        renderTransactions(activeBtn.dataset.category, searchInput.value)
    })

    async function checkAuth() {
        const { data, error } = await supabase.auth.getUser()
        if (!data?.user || error) {
            window.location.href = 'signup.html'
            return null
        }
        return data.user
    }

    async function loadTransactions(user) {
        let query = supabase.from('transactions').select(`
            id,
            amount,
            token_symbol,
            transaction_type,
            description,
            details,
            created_at,
            user:user_id (full_name),
            from_wallet:from_wallet_id (wallet_type),
            to_wallet:to_wallet_id (wallet_type)
        `).order('created_at', { ascending: false })

        if (!user.isAdmin) query = query.eq('user_id', user.id)

        const { data, error } = await query
        if (error) return console.error(error)
        transactions = data
        renderTransactions('all')
    }

    function renderTransactions(category = 'all', search = '') {
        transactionList.innerHTML = ''
        let filtered = transactions

        if (category !== 'all') filtered = filtered.filter(t => t.transaction_type.toLowerCase() === category)
        if (search) {
            const s = search.toLowerCase()
            filtered = filtered.filter(t =>
                t.id.toLowerCase().includes(s) ||
                t.user?.full_name?.toLowerCase().includes(s)
            )
        }

        if (!filtered.length) {
            transactionList.innerHTML = '<li style="text-align:center; color:#666;">No transactions found</li>'
            return
        }

        filtered.forEach(t => {
            const item = document.createElement('li')
            item.className = 'transaction-item'
            item.innerHTML = `
                <div class="transaction-header">
                    <span>${t.transaction_type}</span>
                    <span>${new Date(t.created_at).toLocaleString()}</span>
                </div>
                <div class="transaction-body">
                    <span><strong>ID:</strong> ${t.id}</span>
                    <span><strong>User:</strong> ${t.user?.full_name || '-'}</span>
                    <span><strong>Amount:</strong> ${parseFloat(t.amount).toFixed(4)} ${t.token_symbol}</span>
                    <span><strong>From Wallet:</strong> ${t.from_wallet?.wallet_type || '-'}</span>
                    <span><strong>To Wallet:</strong> ${t.to_wallet?.wallet_type || '-'}</span>
                    <span><strong>Description:</strong> ${t.description || '-'}</span>
                    <span><strong>Details:</strong> ${t.details ? JSON.stringify(t.details) : '-'}</span>
                </div>
            `
            transactionList.appendChild(item)
        })
    }

    (async () => {
        const user = await checkAuth()
        if (!user) return
        await loadTransactions(user)
    })()
})
</script>
