<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blackonstar AI — Signup & Login</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }

    body {
      background: #0a0a0a;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      user-select: none;
    }

    .container {
      background: #121212;
      padding: 40px 35px;
      border-radius: 18px;
      box-shadow: 0 8px 30px rgba(0, 255, 213, 0.3);
      width: 100%;
      max-width: 440px;
      user-select: text;
    }

    h2 {
      color: #00ffd5;
      font-weight: 700;
      font-size: 28px;
      margin-bottom: 25px;
      text-align: center;
      letter-spacing: 1.2px;
    }

    form {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 6px;
      color: #00ffd5;
    }

    input {
      background: #1f1f1f;
      border: 1.5px solid #333;
      border-radius: 12px;
      padding: 14px 18px;
      font-size: 16px;
      color: #eee;
      margin-bottom: 20px;
      transition: border-color 0.3s ease;
    }

    input:focus {
      outline: none;
      border-color: #00ffd5;
      box-shadow: 0 0 8px #00ffd5;
    }

    input::placeholder {
      color: #666;
    }

    .optional-label {
      font-weight: 400;
      font-size: 12px;
      color: #888;
      font-style: italic;
      margin-left: 6px;
      user-select: none;
    }

    button {
      background: #ff3b3b;
      color: #fff;
      border: none;
      padding: 16px 0;
      border-radius: 30px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
      box-shadow: 0 6px 15px rgba(255, 59, 59, 0.5);
      margin-top: 5px;
    }

    button:hover:not(:disabled) {
      background: #e03131;
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(224, 49, 49, 0.7);
    }

    button:disabled {
      background: #6b6b6b;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    #message {
      margin-top: 18px;
      font-weight: 600;
      font-size: 15px;
      min-height: 24px;
      text-align: center;
      user-select: text;
      color: #ff6b6b;
    }

    #message.success {
      color: #69f0ae;
    }

    .toggle-text {
      margin-top: 22px;
      text-align: center;
      font-size: 14px;
      color: #aaa;
      user-select: none;
    }

    .toggle-link {
      color: #00ffd5;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      margin-left: 6px;
      transition: color 0.3s ease;
      user-select: text;
    }

    .toggle-link:hover {
      color: #ff3b3b;
    }

    /* Hide forms by default */
    form > .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container" role="main" aria-label="Authentication form">
    <h2 id="form-title">Create Your Account</h2>

    <!-- Signup Form -->
    <form id="signup-form" novalidate>
      <label for="name">Full Name</label>
      <input type="text" id="name" name="name" placeholder="Your full name" autocomplete="name" required />

      <label for="email-signup">Email Address</label>
      <input type="email" id="email-signup" name="email-signup" placeholder="you@example.com" autocomplete="email" required />

      <label for="password-signup">Password</label>
      <input type="password" id="password-signup" name="password-signup" placeholder="Enter password" autocomplete="new-password" minlength="6" required />

      <label for="confirm-password">Confirm Password</label>
      <input type="password" id="confirm-password" name="confirm-password" placeholder="Re-enter password" autocomplete="new-password" minlength="6" required />

      <label for="invitation-code">
        Invitation Code
        <span class="optional-label">(optional)</span>
      </label>
      <input type="text" id="invitation-code" name="invitation-code" placeholder="Referral or invite code (if any)" autocomplete="off" />

      <button type="submit" id="signup-btn">Sign Up</button>
    </form>

    <!-- Login Form -->
    <form id="login-form" novalidate style="display:none;">
      <label for="email-login">Email Address</label>
      <input type="email" id="email-login" name="email-login" placeholder="you@example.com" autocomplete="email" required />

      <label for="password-login">Password</label>
      <input type="password" id="password-login" name="password-login" placeholder="Enter password" autocomplete="current-password" required />

      <button type="submit" id="login-btn">Log In</button>
    </form>

    <p id="message" role="alert" aria-live="polite"></p>

    <p class="toggle-text" id="toggle-text">
      Already have an account?
      <a href="#" id="toggle-link" class="toggle-link" tabindex="0">Log In</a>
    </p>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const SUPABASE_URL = 'https://nnixqnoxlhdncoppukvw.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uaXhxbm94bGhkbmNvcHB1a3Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MzMyNjIsImV4cCI6MjA3NjQwOTI2Mn0.F2vIAkiX29Bqe7jpJhYPRzjUNJ3n0Fs3Emca-8I9JuE'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const signupForm = document.getElementById('signup-form')
    const loginForm = document.getElementById('login-form')
    const message = document.getElementById('message')
    const formTitle = document.getElementById('form-title')
    const toggleText = document.getElementById('toggle-text')
    const toggleLink = document.getElementById('toggle-link')

    const signupBtn = document.getElementById('signup-btn')
    const loginBtn = document.getElementById('login-btn')

    // Toggle between signup and login views
    function toggleForms() {
      if (signupForm.style.display === 'none') {
        signupForm.style.display = 'flex'
        loginForm.style.display = 'none'
        formTitle.textContent = 'Create Your Account'
        toggleText.innerHTML = `Already have an account? <a href="#" id="toggle-link" class="toggle-link" tabindex="0">Log In</a>`
        message.textContent = ''
        message.classList.remove('success')
      } else {
        signupForm.style.display = 'none'
        loginForm.style.display = 'flex'
        formTitle.textContent = 'Welcome Back'
        toggleText.innerHTML = `Don't have an account? <a href="#" id="toggle-link" class="toggle-link" tabindex="0">Sign Up</a>`
        message.textContent = ''
        message.classList.remove('success')
      }
      document.getElementById('toggle-link').addEventListener('click', (e) => {
        e.preventDefault()
        toggleForms()
      })
    }
    toggleLink.addEventListener('click', (e) => {
      e.preventDefault()
      toggleForms()
    })

    // Generate 7-char referral code
    function generateReferralCode(length = 7) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
      let code = ''
      for (let i = 0; i < length; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length))
      }
      return code
    }

    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault()
      message.textContent = ''
      signupBtn.disabled = true

      const name = signupForm['name'].value.trim()
      const email = signupForm['email-signup'].value.trim()
      const password = signupForm['password-signup'].value
      const confirmPassword = signupForm['confirm-password'].value
      const invitationCode = signupForm['invitation-code'].value.trim().toUpperCase()

      if (password !== confirmPassword) {
        message.textContent = '⚠️ Passwords do not match.'
        signupBtn.disabled = false
        return
      }
      if (password.length < 6) {
        message.textContent = '⚠️ Password must be at least 6 characters.'
        signupBtn.disabled = false
        return
      }

      message.textContent = 'Signing up...'

      try {
        const { data, error } = await supabase.auth.signUp({
          email,
          password,
          options: { data: { display_name: name } }
        })

        if (error) {
          message.textContent = 'Error: ' + error.message
          signupBtn.disabled = false
          return
        }

        if (!data?.user?.id) {
          message.textContent = 'Error: User ID not returned.'
          signupBtn.disabled = false
          return
        }

        const userId = data.user.id
        const referralCode = generateReferralCode(7)

        let referrer = null
        if (invitationCode) {
          const { data: refData, error: refError } = await supabase
            .from('users')
            .select('id, bk_tokens, referral_count')
            .eq('referral_code', invitationCode)
            .single()

          if (refError && refError.code !== 'PGRST116') {
            message.textContent = 'Error checking invitation code: ' + refError.message
            signupBtn.disabled = false
            return
          }
          if (!refData) {
            message.textContent = '⚠️ Invalid referral code.'
            signupBtn.disabled = false
            return
          }
          referrer = refData
        }

        const newUserTokens = referrer ? 10 : 0

        // Insert new user record
        const { error: insertError } = await supabase
          .from('users')
          .insert({
            id: userId,
            email,
            display_name: name,
            referral_code: referralCode,
            invitation_code: referrer ? invitationCode : null,
            bk_tokens: newUserTokens,
            referral_count: 0,
            updated_at: new Date().toISOString()
          })

        if (insertError) {
          message.textContent = 'Signup succeeded but failed to save user data: ' + insertError.message
          signupBtn.disabled = false
          return
        }

        // Reward referrer
        if (referrer) {
          const newTokens = (referrer.bk_tokens || 0) + 50
          const newReferralCount = (referrer.referral_count || 0) + 1

          const { error: updateRefError } = await supabase
            .from('users')
            .update({
              bk_tokens: newTokens,
              referral_count: newReferralCount,
              updated_at: new Date().toISOString()
            })
            .eq('id', referrer.id)

          if (updateRefError) {
            console.warn('Failed to update referrer tokens and referral count:', updateRefError.message)
          }
        }

        message.textContent = '✅ Sign up successful! Please log in.'
        message.classList.add('success')

        signupForm.reset()

        setTimeout(() => {
          toggleForms()
        }, 1800)
      } catch (err) {
        message.textContent = 'Error: ' + err.message
        signupBtn.disabled = false
      }
    })

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault()
      message.textContent = ''
      loginBtn.disabled = true

      const email = loginForm['email-login'].value.trim()
      const password = loginForm['password-login'].value

      if (!email || !password) {
        message.textContent = '⚠️ Please enter email and password.'
        loginBtn.disabled = false
        return
      }

      message.textContent = 'Logging in...'

      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password })

        if (error) {
          message.textContent = 'Error: ' + error.message
          loginBtn.disabled = false
          return
        }

        message.textContent = '✅ Login successful! Redirecting...'
        message.classList.add('success')

        setTimeout(() => {
          window.location.href = '/dashboard' // Adjust as needed
        }, 1500)
      } catch (err) {
        message.textContent = 'Error: ' + err.message
        loginBtn.disabled = false
      }
    })
  </script>
</body>
</html>
